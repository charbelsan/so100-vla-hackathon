<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <title>SO100 VLA Demo</title>
    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: #111;
        color: #f5f5f5;
        display: flex;
        flex-direction: column;
        height: 100vh;
      }
      header {
        padding: 0.75rem 1rem;
        background: #181818;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
      }
      header h1 {
        font-size: 1.1rem;
        margin: 0;
      }
      #phase-indicator {
        font-size: 0.9rem;
        padding: 0.15rem 0.5rem;
        border-radius: 999px;
        background: #333;
      }
      main {
        flex: 1;
        display: grid;
        grid-template-columns: 2fr 1.2fr;
        gap: 0.5rem;
        padding: 0.5rem;
        min-height: 0;
      }
      section {
        background: #181818;
        border-radius: 6px;
        border: 1px solid #333;
        display: flex;
        flex-direction: column;
        min-height: 0;
      }
      section h2 {
        font-size: 0.95rem;
        margin: 0;
        padding: 0.5rem 0.75rem;
        border-bottom: 1px solid #333;
      }
      #video-container {
        flex: 1;
        display: flex;
        align-items: center;
        justify-content: center;
        background: #000;
      }
      #video {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }
      #controls {
        padding: 0.5rem 0.75rem;
        border-top: 1px solid #333;
        display: flex;
        flex-wrap: wrap;
        gap: 0.4rem;
      }
      button {
        background: #2d6cdf;
        border: none;
        color: #fff;
        padding: 0.25rem 0.7rem;
        border-radius: 4px;
        font-size: 0.85rem;
        cursor: pointer;
      }
      button.secondary {
        background: #333;
      }
      button:disabled {
        background: #333;
        cursor: default;
        opacity: 0.7;
      }
      #status-bar {
        font-size: 0.8rem;
        padding: 0.3rem 0.75rem;
        border-top: 1px solid #333;
        background: #141414;
      }
      #chat-log,
      #reasoning-log {
        flex: 1;
        padding: 0.5rem 0.75rem;
        overflow-y: auto;
        font-size: 0.85rem;
      }
      .log-entry {
        margin-bottom: 0.35rem;
      }
      .log-entry span.role {
        font-weight: 600;
        margin-right: 0.35rem;
      }
      .log-entry.system {
        color: #9aa0a6;
      }
      .log-entry.assistant {
        color: #a5d6ff;
      }
      .log-entry.user {
        color: #e8eaed;
      }
      #chat-input-row {
        display: flex;
        padding: 0.4rem 0.75rem 0.6rem;
        gap: 0.4rem;
        border-top: 1px solid #333;
      }
      #chat-input {
        flex: 1;
        background: #111;
        border-radius: 4px;
        border: 1px solid #333;
        padding: 0.25rem 0.5rem;
        color: inherit;
        font-size: 0.85rem;
      }
      #chat-input:focus {
        outline: none;
        border-color: #2d6cdf;
      }
      footer {
        padding: 0.3rem 0.75rem;
        font-size: 0.75rem;
        border-top: 1px solid #333;
        background: #141414;
        color: #9aa0a6;
      }
    </style>
  </head>
  <body>
    <header>
      <h1>SO100 VLA Demo (Mockâ€‘Ready)</h1>
      <div id="phase-indicator">Idle</div>
    </header>

    <main>
      <section id="video-section">
        <h2>Camera</h2>
        <div id="video-container">
          <img id="video" alt="Camera feed will appear here" />
        </div>
        <div id="controls">
          <button id="connect-btn">Connect</button>
          <button id="disconnect-btn" disabled>Disconnect</button>
          <button id="start-stream-btn" disabled>Start Stream</button>
          <button id="stop-stream-btn" disabled class="secondary">
            Stop Stream
          </button>
          <button id="find-red-btn" disabled>Find Red Cup</button>
          <button id="find-blue-btn" disabled class="secondary">
            Find Blue Block
          </button>
          <button id="find-green-btn" disabled class="secondary">
            Find Green Ball
          </button>
        </div>
        <div id="status-bar">
          Status: <span id="status-text">Disconnected</span>
        </div>
      </section>

      <section id="chat-section">
        <h2>Chat & Reasoning</h2>
        <div id="chat-log"></div>
        <div id="reasoning-log"></div>
        <div id="chat-input-row">
          <input
            id="chat-input"
            type="text"
            placeholder="Ask the model about the scene..."
          />
          <button id="send-chat-btn" disabled>Send</button>
        </div>
      </section>
    </main>

    <footer>
      This UI talks to the FastAPI WebSocket server at
      <code>/ws</code>. In mock mode
      (<code>USE_MOCK_ROBOT=true</code>), everything runs without hardware.
    </footer>

    <script>
      let ws = null;
      let isConnected = false;

      const connectBtn = document.getElementById("connect-btn");
      const disconnectBtn = document.getElementById("disconnect-btn");
      const startStreamBtn = document.getElementById("start-stream-btn");
      const stopStreamBtn = document.getElementById("stop-stream-btn");
      const findRedBtn = document.getElementById("find-red-btn");
      const findBlueBtn = document.getElementById("find-blue-btn");
      const findGreenBtn = document.getElementById("find-green-btn");
      const sendChatBtn = document.getElementById("send-chat-btn");
      const chatInput = document.getElementById("chat-input");
      const videoImg = document.getElementById("video");
      const chatLog = document.getElementById("chat-log");
      const reasoningLog = document.getElementById("reasoning-log");
      const statusText = document.getElementById("status-text");
      const phaseIndicator = document.getElementById("phase-indicator");

      function setPhase(phase) {
        phaseIndicator.textContent = phase || "Idle";
      }

      function appendChat(role, text) {
        const div = document.createElement("div");
        div.classList.add("log-entry", role);
        const roleSpan = document.createElement("span");
        roleSpan.classList.add("role");
        roleSpan.textContent = role === "assistant" ? "Assistant" : "User";
        const textSpan = document.createElement("span");
        textSpan.textContent = text;
        div.appendChild(roleSpan);
        div.appendChild(textSpan);
        chatLog.appendChild(div);
        chatLog.scrollTop = chatLog.scrollHeight;
      }

      function appendReasoning(text) {
        const div = document.createElement("div");
        div.classList.add("log-entry", "system");
        div.textContent = text;
        reasoningLog.appendChild(div);
        reasoningLog.scrollTop = reasoningLog.scrollHeight;
      }

      function setConnectedUi(connected) {
        isConnected = connected;
        connectBtn.disabled = connected;
        disconnectBtn.disabled = !connected;
        startStreamBtn.disabled = !connected;
        stopStreamBtn.disabled = !connected;
        findRedBtn.disabled = !connected;
        findBlueBtn.disabled = !connected;
        findGreenBtn.disabled = !connected;
        sendChatBtn.disabled = !connected;
        chatInput.disabled = !connected;
        statusText.textContent = connected ? "Connected" : "Disconnected";
        if (!connected) {
          setPhase("Idle");
        }
      }

      function connectWs() {
        if (ws && isConnected) return;
        const proto = window.location.protocol === "https:" ? "wss" : "ws";
        const url = `${proto}://${window.location.host}/ws`;
        ws = new WebSocket(url);

        ws.onopen = () => {
          setConnectedUi(true);
          appendReasoning("WebSocket connected.");
        };

        ws.onclose = () => {
          setConnectedUi(false);
          appendReasoning("WebSocket disconnected.");
        };

        ws.onerror = (ev) => {
          console.error("WebSocket error", ev);
        };

        ws.onmessage = (ev) => {
          try {
            const data = JSON.parse(ev.data);
            handleMessage(data);
          } catch {
            console.warn("Non-JSON message from server:", ev.data);
          }
        };
      }

      function handleMessage(msg) {
        const type = msg.type;
        if (type === "frame") {
          if (msg.image_b64) {
            videoImg.src = `data:image/jpeg;base64,${msg.image_b64}`;
          }
        } else if (type === "chat") {
          appendChat("assistant", msg.text || "");
        } else if (type === "status") {
          if (msg.phase) {
            setPhase(
              msg.phase.charAt(0).toUpperCase() + msg.phase.slice(1)
            );
          }
          if (msg.text) {
            appendReasoning(`[status] ${msg.text}`);
          }
        } else if (type === "reasoning") {
          if (msg.thought) {
            appendReasoning(msg.thought);
          }
        } else if (type === "error") {
          appendReasoning(`[error] ${msg.text || "Unknown error"}`);
        }
      }

      function sendJson(obj) {
        if (!ws || ws.readyState !== WebSocket.OPEN) {
          appendReasoning("Cannot send message: WebSocket not open.");
          return;
        }
        ws.send(JSON.stringify(obj));
      }

      connectBtn.addEventListener("click", () => {
        connectWs();
      });

      disconnectBtn.addEventListener("click", () => {
        if (ws) {
          ws.close();
        }
      });

      startStreamBtn.addEventListener("click", () => {
        sendJson({ type: "command", action: "start_stream" });
      });

      stopStreamBtn.addEventListener("click", () => {
        sendJson({ type: "command", action: "stop_stream" });
      });

      findRedBtn.addEventListener("click", () => {
        sendJson({
          type: "command",
          action: "search_and_grasp",
          object: "red cup",
        });
      });

      findBlueBtn.addEventListener("click", () => {
        sendJson({
          type: "command",
          action: "search_and_grasp",
          object: "blue block",
        });
      });

      findGreenBtn.addEventListener("click", () => {
        sendJson({
          type: "command",
          action: "search_and_grasp",
          object: "green ball",
        });
      });

      sendChatBtn.addEventListener("click", () => {
        const text = chatInput.value.trim();
        if (!text) return;
        appendChat("user", text);
        chatInput.value = "";
        sendJson({ type: "chat", text });
      });

      chatInput.addEventListener("keydown", (ev) => {
        if (ev.key === "Enter" && !ev.shiftKey) {
          ev.preventDefault();
          sendChatBtn.click();
        }
      });
    </script>
  </body>
  </html>

